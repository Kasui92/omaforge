#!/bin/bash

OMAFORGE_PATH="$HOME/.local/share/omaforge"
OMAFORGE_VERSION=$(source "$OMAFORGE_PATH/bin/scripts/omaforge-version" && echo "$OMAFORGE_VERSION")
OMAFORGE_UPDATE_AVAILABLE=$(source "$OMAFORGE_PATH/bin/scripts/omaforge-update-available" && echo "$OMAFORGE_UPDATE_AVAILABLE")

header_menu() {
  clear
  echo -e "\n\e[1;36m$(cat ~/.local/share/omaforge/logo.txt)\e[0m"
  echo -e "                                                     $OMAFORGE_VERSION"
  echo -e "$OMAFORGE_UPDATE_AVAILABLE"
}

main_menu() {
  header_menu

  local options=("Update" "Theme" "Font" "Apps" "Manual" "Exit")
  choice=$(printf "%s\n" "${options[@]}" | gum choose --header "") || exit 0
  case "$choice" in
  Update) update_menu ;;
  Theme) theme_menu ;;
  Font) font_menu ;;
  Apps) apps_menu ;;
  Manual) open_manual ;;
  Exit) clear && exit 0 ;;
  esac
}

update_menu() {
  header_menu

  local menu=("Omaforge" "System" "Firmware" "Back")
  local scripts=(
    "omaforge-update"
    "omaforge-update-system"
    "omaforge-update-firmware"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Update") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        source "$OMAFORGE_PATH/bin/scripts/${scripts[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done
}

theme_menu() {
  header_menu
  source "$OMAFORGE_PATH/bin/scripts/omaforge-theme-menu"
  ack_command
  main_menu
}

font_menu() {
  header_menu
  source "$OMAFORGE_PATH/bin/scripts/omaforge-font-menu"
  ack_command
  main_menu
}

apps_menu() {
  header_menu
  local menu=("Install" "Uninstall" "Back")
  local scripts=(
    "omaforge-apps-install-menu"
    "omaforge-apps-uninstall-menu"
    "main_menu"
  )
  local choice
  choice=$(printf "%s\n" "${menu[@]}" | gum choose --header="Apps") || main_menu
  for i in "${!menu[@]}"; do
    if [[ "${menu[$i]}" == "$choice" ]]; then
      if [[ "$choice" == "Back" ]]; then
        main_menu
      else
        source "$OMAFORGE_PATH/bin/scripts/${scripts[$i]}"
        ack_command
        main_menu
      fi
      break
    fi
  done
}

open_manual() {
  setsid chromium --new-window --ozone-platform=wayland --app="https://github.com/Kasui92/omaforge/wiki" >/dev/null 2>&1 &
  clear
}

ack_command() {
  gum spin --spinner "globe" --title "Done!" -- sleep 1
}

main_menu